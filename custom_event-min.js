// custom_event.js
// Created 2010/05/07 by Wolfger Schramm <wolfger@spearwolf.de>
(function(){function s(){typeof i.console!=="undefined"&&console.error(Array.prototype.slice.call(arguments).join(" "))}function h(a,b){this.name=a;this.parentNode=b;this.children=[];this.greedyChildren=[];this.insatiableChildren=[];this.callbacks=[]}function r(e,b,c){c=c||{};c.name=e;var f=m.findOrCreateNode(e).addCallback(b,c);return{id:f.id,name:f.name,unbind:function(){a.unbind(f.id)},emit:function(){a.emit.apply(i,[f.name].concat(Array.prototype.slice.call(arguments)))},pause:function(b){if(typeof b===
"boolean")f.paused=b;return f.paused}}}function n(a,b){b=b||m;if(typeof a==="number")if(b.destroyCallbacks([a])>0)return!0;else{var c;for(c=0;c<b.children.length;c++)if(n(a,b.children[c]))return!0;for(c=0;c<b.greedyChildren.length;c++)if(n(a,b.greedyChildren[c]))return!0;for(c=0;c<b.insatiableChildren.length;c++)if(n(a,b.insatiableChildren[c]))return!0;return!1}}function t(e,b){e=e.replace(/\/+$/,"");var c=[],f=[],g;a.options.debug&&console.group("_E.Module ->",e);"_init"in b&&(a.options.debug&&console.log("constructor",
e+a.options.pathSeparator+a.options.insatiableSequence),c.push(a.once(e+a.options.pathSeparator+a.options.insatiableSequence,b._init,{binding:b})));for(var d in b)if(b.hasOwnProperty(d)&&(g=d.match(/^(on|module) (.+)$/)))g[1]==="on"&&typeof b[d]==="function"&&d!=="_init"&&(g=g[2].split(" "),g.length===1?(a.options.debug&&console.log("on",e+a.options.pathSeparator+g[0]),c.push(a.on(e+a.options.pathSeparator+g[0],b[d],{binding:b}))):g[1]===".."&&(a.options.debug&&console.log("on",e+a.options.pathSeparator+
g[0]+a.options.pathSeparator+a.options.insatiableSequence),c.push(a.on(e+a.options.pathSeparator+g[0]+a.options.pathSeparator+a.options.insatiableSequence,b[d],{binding:b})))),g[1]==="module"&&typeof b[d]==="object"&&f.push(t(e+a.options.pathSeparator+g[2],b[d]));a.options.debug&&console.groupEnd();b.destroy=function(){var b;for(b=0;b<c.length;++b)c[b].unbind();for(b=0;b<f.length;++b)f[b].destroy()};var u=!1;b.pause=function(b){if(typeof b==="boolean"){u=b;var a;for(a=0;a<c.length;++a)c[a].pause(b);
for(a=0;a<f.length;++a)f[a].pause(b)}return u};return b}var i=this,a={VERSION:"0.6.8"};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)exports=module.exports=a;exports._E=a}else typeof define==="function"&&define.amd?define("custom_event",function(){return a}):i._E=a;var m=new h,w=1;h.prototype.fullPathName=function(){return typeof this.name==="undefined"?a.options.pathSeparator:this._fullPathName()};h.prototype._fullPathName=function(){return typeof this.name==="undefined"?
"":this.parentNode._fullPathName()+a.options.pathSeparator+this.name};h.prototype.addChild=function(e){var b=new h(e,this);e===a.options.greedyChar?this.greedyChildren.push(b):e===a.options.insatiableSequence?this.insatiableChildren.push(b):this.children.push(b);return b};h.prototype.splitPath=function(e){e=e.split(a.options.pathSeparator);for(var b=null;b===null||b.length===0;)b=e.shift();if(b===a.options.insatiableSequence)return[b,""];for(var c=[],f=0;f<e.length;f++)if(c.push(e[f]),e[f]===a.options.insatiableSequence)break;
return[b,c.length===0?"":c.join(a.options.pathSeparator)]};h.prototype.matchNodes=function(e,b){var c=this.splitPath(e),f=c[0];c=c[1];var g,d;for(d=0;d<this.insatiableChildren.length;d++)b(this.insatiableChildren[d],e);if(c.length>0){for(d=0;d<this.children.length;d++)g=this.children[d],(f===a.options.greedyChar||f===g.name)&&g.matchNodes(c,b);for(d=0;d<this.greedyChildren.length;d++)this.greedyChildren[d].matchNodes(c,b)}else{for(d=0;d<this.children.length;d++)g=this.children[d],(f===a.options.greedyChar||
f===g.name)&&b(g);for(d=0;d<this.greedyChildren.length;d++)b(this.greedyChildren[d])}};h.prototype.findOrCreateNode=function(a){var b=this.splitPath(a);a=b[0];b=b[1];var c=function(b){return function(a){var c,e;for(c=0;c<b.children.length;c++)if(e=b.children[c],a===e.name)return e;for(c=0;c<b.greedyChildren.length;c++)if(e=b.greedyChildren[c],a===e.name)return e;return null}}(this)(a);c===null&&(c=this.addChild(a));return b.length>0?c.findOrCreateNode(b):c};h.prototype.addCallback=function(a,b){var c=
{id:w++,name:b.name,fn:a,once:!!b.once,binding:b.binding,paused:!1};this.callbacks.push(c);return c};h.prototype.destroyCallbacks=function(a){var b=[],c,f,g,d=0;for(c=0;c<this.callbacks.length;c++){g=!1;for(f=0;f<a.length;f++)if(this.callbacks[c].id==a[f]){g=!0;++d;break}g||b.push(this.callbacks[c])}this.callbacks=b;return d};a.on=r;a.onIdle=function(a,b,c,f){function g(){o&&clearTimeout(o);o=void 0}function d(a){a&&(i=a);g();o=setTimeout(h,i)}function h(){o=void 0;l.pause(!0);c.apply(q);q.pause()||
(d(),l.pause(!1))}var o,l,v=!1,i=b,q={unbind:function(){g();l.unbind()},pause:function(a,b){if(typeof a==="undefined")return v;(v=a)?(g(),l.pause(!0)):o||(d(b),l.pause(!1))},start:function(a){this.pause(!1,a)},stop:function(){this.pause(!0)},touch:function(){l.emit()}};l=r(a,d,f);d();return q};a.once=function(a,b,c){c=c||{};c.once=!0;return r(a,b,c)};a.emit=function(e){a.options.debug&&console.group("_E.emit ->",e);var b=[],c=[],f,g,d;g=1;for(d=arguments.length;g<d;++g)g===d-1&&typeof arguments[g]===
"function"?f=arguments[g]:b.push(arguments[g]);var h;typeof a._emitStackTrace!=="object"?a._emitStackTrace={currentLevel:1}:++a._emitStackTrace.currentLevel;h=a._emitStackTrace;m.matchNodes(e,function(d,f){try{var i=[],m=function(a){return function(){i.push(a)}},q=function(a){return function(){a.paused=!0}},p,k,j;for(g=0;g<d.callbacks.length;g++)if(j=d.callbacks[g],!j.paused)if(a.options.skipRecursionCheck||!(j.id in a._emitStackTrace)){h[j.id]=1;k=j.binding||{};k.name=e;k.unbind=m(j.id);if(typeof k.pause!==
"function")k.pause=q(j);typeof f!=="undefined"?(k.pathArgs=f.split(a.options.pathSeparator),p=j.fn.apply(k,k.pathArgs.concat(b))):p=j.fn.apply(k,b);j.once&&i.push(j.id);p!==null&&typeof p!=="undefined"&&c.push(p)}else a.options.skipRecursionCheck||s("recursion check failed on "+e);d.destroyCallbacks(i)}catch(n){s(n)}});--a._emitStackTrace.currentLevel;if(a._emitStackTrace.currentLevel===0)a._emitStackTrace={currentLevel:0};f&&c.length>0&&f.apply(i,c);a.options.debug&&console.groupEnd()};a.connect=
function(){var e=Array.prototype.slice.call(arguments),b=e.shift();return a.on(b,function(){for(var b=Array.prototype.slice.call(arguments),f=0;f<e.length;++f)a.emit.apply(this,[e[f]].concat(b))})};a.unbind=n;a.Module=t;a.options={pathSeparator:"/",greedyChar:"*",insatiableSequence:"**",debug:!1,skipRecursionCheck:!1};a._rootNode=m})();
