// custom_event.js
// ===============
//
// Created at 2010/05/07
// Copyright (c) 2010-2013 Wolfger Schramm <wolfger@spearwolf.de>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
(function(){var m,v,q,s;function z(c,d,a,b){var f=w++,c={name:c,eType:d,node:a};d===m&&(c.callback=b.callback);t[f]=c;return f}function j(c,d){this.eType=v;this.name=c;this.parentNode=d;this.children=[];this.greedyChildren=[];this.insatiableChildren=[];this.callbacks=[]}function x(c,d){var a=(d||{}).except||[],b;a instanceof Array||(a=[a]);for(b in c)c.hasOwnProperty(b)&&-1===a.indexOf(b)&&delete c[b]}function u(c,d,a){var a=a||{},b=null;if("string"===typeof c)return a.name=c,b=p.findOrCreateNode(c).addCallback(d,
a),{eType:s,id:b.id,name:b.name,destroy:function(){e.destroy(b.id);x(this)},emit:function(){e.emit.apply(i,[b.name].concat(Array.prototype.slice.call(arguments)))},pause:function(a){return"boolean"===typeof a?b.paused=a:b.paused}};if("function"===typeof c&&c.eType===q)return c.on(d)}function y(c,d){var a=[],b=[],f,g,n,l=c,h=d;(n="object"===typeof l)?"function"===typeof l.collect&&(f=l.collect):(h=c,l={});for(g=n?2:1,n=arguments.length;g<n;++g)!0===l.collect&&g===n-1&&"function"===typeof arguments[g]?
f=arguments[g]:a.push(arguments[g]);o.traceGroup("_e.emit ->",h);var j;"object"!==typeof e._emitStackTrace?e._emitStackTrace={currentLevel:1,topicPath:[]}:++e._emitStackTrace.currentLevel;j=e._emitStackTrace;p.matchNodes(h,function(c,d){try{var f=[],l=function(a){return function(){f.push(a)}},n,i,k,m;for(g=0;g<c.callbacks.length;g++)k=c.callbacks[g],k.paused?o.trace("_e.on -> (paused)",k.name,"["+k.id+"]",k):0>j.topicPath.indexOf(k.id)?(j.topicPath.push(k.id),i=k.binding||{},i.name=h,i.destroy=l(k.id),
"undefined"===typeof i.eType&&(i.eType=s),m=a,"undefined"!==typeof d&&(i.pathArgs=d.split(e.options.pathSeparator),m=i.pathArgs.concat(a)),o.trace("_e.on ->",k.name,"["+k.id+"]",k,"args=",m),n=k.fn.apply(i,m),k.once&&f.push(k.id),null!==n&&"undefined"!==typeof n&&b.push(n),j.topicPath.pop()):o.error("_e.on -> (skipped/recursion)",k.name,"["+k.id+"]",k);c.destroyCallbacks(f)}catch(p){o.error(p)}});--e._emitStackTrace.currentLevel;0===e._emitStackTrace.currentLevel&&(e._emitStackTrace={currentLevel:0,
topicPath:[]});f&&0<b.length&&f.apply(i,b);o.traceGroupEnd()}function r(c,d){var a,d=d||p;if("number"===typeof c)if(a=t[c]){if(a.eType===m){var b=a.node.eValueObject.listener;a=a.callback;var f;for(f=0;f<b.length;f++)if(b[f]===a){b.splice(f,1);break}return!0}delete t[c]}else{if(0<d.destroyCallbacks([c]))return!0;for(b=0;b<d.children.length;b++)if(r(c,d.children[b]))return!0;for(b=0;b<d.greedyChildren.length;b++)if(r(c,d.greedyChildren[b]))return!0;for(b=0;b<d.insatiableChildren.length;b++)if(r(c,
d.insatiableChildren[b]))return!0}return!1}var i=this,e={VERSION:"0.7.0-pre2"};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=e),exports._e=e):"function"===typeof define&&define.amd?(define("custom_event",function(){return e}),define("custom_event/global",function(){return i._e=e})):i._e=e;var o=function(){var c="undefined"!==typeof i.console&&"function"===typeof Function&&"function"===typeof Function.prototype.bind,d=c&&"function"===typeof i.console.group,
a={},b=!c?void 0:function(a){return Function.prototype.bind.call(console[a],console)},f=c?b("error"):null,g=c?b("log"):null,n=c?b("log"):null,l=d?b("group"):null,h="";c?(a.error=function(){f.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debug=function(){e.options.debug&&g.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.trace=function(){e.options.trace&&n.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},
d?(a.debugGroup=function(){e.options.debug&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debugGroupEnd=function(){e.options.debug&&console.groupEnd()},a.traceGroup=function(){e.options.trace&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.traceGroupEnd=function(){e.options.trace&&console.groupEnd()}):(a.debugGroup=function(){e.options.debug&&(g.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),
h+="    ")},a.traceGroup=function(){e.options.trace&&(n.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),h+="    ")},a.traceGroupEnd=a.debugGroupEnd=function(){h=h.substr(0,h.length-4)})):a.error=a.debug=a.trace=a.traceGroup=a.traceGroupEnd=function(){};return a}();v="EventNode";q="ValueFunction";m="ValueChangeListener";s="EventListener";var w=1,t={},p=new j;j.prototype.fullPathName=function(){return"undefined"===typeof this.name?e.options.pathSeparator:this._fullPathName()};
j.prototype._fullPathName=function(){return"undefined"===typeof this.name?"":this.parentNode._fullPathName()+e.options.pathSeparator+this.name};j.prototype.addChild=function(c){var d=new j(c,this);c===e.options.greedyChar?this.greedyChildren.push(d):c===e.options.insatiableSequence?this.insatiableChildren.push(d):this.children.push(d);return d};j.prototype.splitPath=function(c){for(var c=c.split(e.options.pathSeparator),d=null;null===d||0===d.length;)d=c.shift();if(d===e.options.insatiableSequence)return[d,
""];for(var a=[],b=0;b<c.length&&!(a.push(c[b]),c[b]===e.options.insatiableSequence);b++);return[d,0===a.length?"":a.join(e.options.pathSeparator)]};j.prototype.matchNodes=function(c,d){var a=this.splitPath(c),b=a[0],a=a[1],f=this,g;for(g=0;g<f.insatiableChildren.length;g++)d(f.insatiableChildren[g],c);if(0<a.length){for(g=0;g<this.children.length;g++)f=this.children[g],(b===e.options.greedyChar||b===f.name)&&f.matchNodes(a,d);for(g=0;g<this.greedyChildren.length;g++)this.greedyChildren[g].matchNodes(a,
d)}else{for(g=0;g<this.children.length;g++)f=this.children[g],(b===e.options.greedyChar||b===f.name)&&d(f);for(g=0;g<this.greedyChildren.length;g++)d(this.greedyChildren[g])}};j.prototype.findOrCreateNode=function(c,d){var a=this.splitPath(c),b=a[0],a=a[1],d="undefined"===typeof d?!0:d,f=function(a){return function(c){var b,f;for(b=0;b<a.children.length;b++)if(f=a.children[b],c===f.name)return f;if(d)for(b=0;b<a.greedyChildren.length;b++)if(f=a.greedyChildren[b],c===f.name)return f;return null}}(this)(b);
null===f&&(f=this.addChild(b));return 0<a.length?f.findOrCreateNode(a):f};j.prototype.addCallback=function(c,d){var a={eType:"eCallback",id:w++,name:d.name,fn:c,once:!!d.once,binding:d.binding,paused:!1};this.callbacks.push(a);return a};j.prototype.destroyCallbacks=function(c){var d=[],a,b,f,e=0;for(a=0;a<this.callbacks.length;a++){f=!1;for(b=0;b<c.length;b++)if(this.callbacks[a].id==c[b]){f=!0;++e;break}f||d.push(this.callbacks[a])}this.callbacks=d;return e};e.on=u;e.idle=function(c,d,a,b){function f(){l&&
clearTimeout(l);l=void 0}function e(a){a&&(m=a);f();l=setTimeout(i,m)}function i(){l=void 0;h.pause(!0);a.apply(o);o.pause()||(e(),h.pause(!1))}var l,h,j=!1,m=d,o={eType:"IdleEventListener",destroy:function(){f();h.destroy()},pause:function(a,b){if("undefined"===typeof a)return j;(j=a)?(f(),h.pause(!0)):l||(e(b),h.pause(!1))},start:function(a){this.pause(!1,a)},stop:function(){this.pause(!0)},touch:function(){h.emit()}};h=u(c,e,b);e();return o};e.once=function(c,d,a){a=a||{};a.once=!0;return u(c,
d,a)};e.emit=y;e.collect=function(){y.apply(i,[{collect:!0}].concat(Array.prototype.slice.call(arguments)))};e.connect=function(){var c=Array.prototype.slice.call(arguments),d=c.shift();return e.on(d,function(){for(var a=Array.prototype.slice.call(arguments),b=0;b<c.length;++b)if("string"===typeof c[b])e.emit.apply(i,[c[b]].concat(a));else if("function"===typeof c[b]&&c[b].eType===q)c[b](a[0])})};e.destroy=r;e.val=function(c){var d=p.findOrCreateNode(c,!1);"undefined"===typeof d.eValueObject&&(d.eValueObject=
{eType:"ValueObject",name:c,data:void 0,initialized:!1,getterQueue:[],listener:[]},d.eValueFunction=function(a){var b=function(){return 0===arguments.length?d.eValueFunction.get():d.eValueFunction.set(arguments[0])};b.eType=q;b.eValueObject=a;b.set=function(b){a.data=b;if(!a.initialized){for(b=0;b<a.getterQueue.length;b++)try{a.getterQueue[b](a.data)}catch(c){o.error("e_val('"+a.name+"') getter error",c)}delete a.getterQueue;a.initialized=!0}for(b=0;b<a.listener.length;b++)try{a.listener[b](a.data)}catch(d){o.error("e_val('"+
a.name+"') on[change] listener error",d)}return a.data};b.on=function(b){a.listener.push(b);var c=z(a.name,m,d,{callback:b});return{eType:m,id:c,name:a.name,destroy:function(){e.destroy(c);x(this)}}};b.get=function(b){if("function"===typeof b)a.initialized?b(a.data):a.getterQueue.push(b);else return a.data};b.isEqual=function(b){return a.data===b};b.isDefined=function(){return a.initialized};return b}(d.eValueObject));return d.eValueFunction};e.get=function(c,d){e.val(c).get(d)};e.set=function(c,
d){e.val(c).set(d)};e.options={pathSeparator:"/",greedyChar:"*",insatiableSequence:"**",trace:!1,debug:!1};e._rootNode=p;e.log=o})();
