// custom_event.js
// ===============
//
// Created at 2010/05/07
// Copyright (c) 2010-2012 Wolfger Schramm <wolfger@spearwolf.de>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
(function(){function j(b,c){this.eType=u;this.name=b;this.parentNode=c;this.children=[];this.greedyChildren=[];this.insatiableChildren=[];this.callbacks=[]}function q(b,c,a){var a=a||{},f=null;if("string"===typeof b)return a.name=b,f=m.findOrCreateNode(b).addCallback(c,a),{eType:s,id:f.id,name:f.name,destroy:function(){d.destroy(f.id);delete this.eType;delete this.id;delete this.name;delete this.destroy;delete this.emit;delete this.pause},emit:function(){d.emit.apply(i,[f.name].concat(Array.prototype.slice.call(arguments)))},
pause:function(a){return"boolean"===typeof a?f.paused=a:f.paused}};if("function"===typeof b&&b.eType===r)return b.on(c),{eType:v,name:b.eValueObject.name}}function t(b,c){var a=[],f=[],g,e,n,l=b,h=c;(n="object"===typeof l)?"function"===typeof l.collect&&(g=l.collect):(h=b,l={});for(e=n?2:1,n=arguments.length;e<n;++e)!0===l.collect&&e===n-1&&"function"===typeof arguments[e]?g=arguments[e]:a.push(arguments[e]);o.traceGroup("_e.emit ->",h);var j;"object"!==typeof d._emitStackTrace?d._emitStackTrace=
{currentLevel:1,topicPath:[]}:++d._emitStackTrace.currentLevel;j=d._emitStackTrace;m.matchNodes(h,function(b,c){try{var g=[],l=function(a){return function(){g.push(a)}},n,i,k,m;for(e=0;e<b.callbacks.length;e++)k=b.callbacks[e],k.paused?o.trace("_e.on -> (paused)",k.name,"["+k.id+"]",k):0>j.topicPath.indexOf(k.id)?(j.topicPath.push(k.id),i=k.binding||{},i.name=h,i.destroy=l(k.id),"undefined"===typeof i.eType&&(i.eType=s),m=a,"undefined"!==typeof c&&(i.pathArgs=c.split(d.options.pathSeparator),m=i.pathArgs.concat(a)),
o.trace("_e.on ->",k.name,"["+k.id+"]",k,"args=",m),n=k.fn.apply(i,m),k.once&&g.push(k.id),null!==n&&"undefined"!==typeof n&&f.push(n),j.topicPath.pop()):o.error("_e.on -> (skipped/recursion)",k.name,"["+k.id+"]",k);b.destroyCallbacks(g)}catch(p){o.error(p)}});--d._emitStackTrace.currentLevel;0===d._emitStackTrace.currentLevel&&(d._emitStackTrace={currentLevel:0,topicPath:[]});g&&0<f.length&&g.apply(i,f);o.traceGroupEnd()}function p(b,c){c=c||m;if("number"===typeof b){if(0<c.destroyCallbacks([b]))return!0;
var a;for(a=0;a<c.children.length;a++)if(p(b,c.children[a]))return!0;for(a=0;a<c.greedyChildren.length;a++)if(p(b,c.greedyChildren[a]))return!0;for(a=0;a<c.insatiableChildren.length;a++)if(p(b,c.insatiableChildren[a]))return!0;return!1}}var i=this,d={VERSION:"0.7.0-pre2"};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports._e=d):"function"===typeof define&&define.amd?(define("custom_event",function(){return d}),define("custom_event/global",
function(){return i._e=d})):i._e=d;var o=function(){var b="undefined"!==typeof i.console&&"function"===typeof Function&&"function"===typeof Function.prototype.bind,c=b&&"function"===typeof i.console.group,a={},f=!b?void 0:function(a){return Function.prototype.bind.call(console[a],console)},g=b?f("error"):null,e=b?f("log"):null,n=b?f("log"):null,l=c?f("group"):null,h="";b?(a.error=function(){g.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debug=function(){d.options.debug&&
e.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.trace=function(){d.options.trace&&n.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},c?(a.debugGroup=function(){d.options.debug&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debugGroupEnd=function(){d.options.debug&&console.groupEnd()},a.traceGroup=function(){d.options.trace&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},
a.traceGroupEnd=function(){d.options.trace&&console.groupEnd()}):(a.debugGroup=function(){d.options.debug&&(e.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),h+="    ")},a.traceGroup=function(){d.options.trace&&(n.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),h+="    ")},a.traceGroupEnd=a.debugGroupEnd=function(){h=h.substr(0,h.length-4)})):a.error=a.debug=a.trace=a.traceGroup=a.traceGroupEnd=function(){};return a}(),u="EventNode",r="ValueFunction",
v="ValueChangeListener",s="EventListener",m=new j,w=1;j.prototype.fullPathName=function(){return"undefined"===typeof this.name?d.options.pathSeparator:this._fullPathName()};j.prototype._fullPathName=function(){return"undefined"===typeof this.name?"":this.parentNode._fullPathName()+d.options.pathSeparator+this.name};j.prototype.addChild=function(b){var c=new j(b,this);b===d.options.greedyChar?this.greedyChildren.push(c):b===d.options.insatiableSequence?this.insatiableChildren.push(c):this.children.push(c);
return c};j.prototype.splitPath=function(b){for(var b=b.split(d.options.pathSeparator),c=null;null===c||0===c.length;)c=b.shift();if(c===d.options.insatiableSequence)return[c,""];for(var a=[],f=0;f<b.length&&!(a.push(b[f]),b[f]===d.options.insatiableSequence);f++);return[c,0===a.length?"":a.join(d.options.pathSeparator)]};j.prototype.matchNodes=function(b,c){var a=this.splitPath(b),f=a[0],a=a[1],g=this,e;for(e=0;e<g.insatiableChildren.length;e++)c(g.insatiableChildren[e],b);if(0<a.length){for(e=0;e<
this.children.length;e++)g=this.children[e],(f===d.options.greedyChar||f===g.name)&&g.matchNodes(a,c);for(e=0;e<this.greedyChildren.length;e++)this.greedyChildren[e].matchNodes(a,c)}else{for(e=0;e<this.children.length;e++)g=this.children[e],(f===d.options.greedyChar||f===g.name)&&c(g);for(e=0;e<this.greedyChildren.length;e++)c(this.greedyChildren[e])}};j.prototype.findOrCreateNode=function(b,c){var a=this.splitPath(b),f=a[0],a=a[1],c="undefined"===typeof c?!0:c,d=function(a){return function(b){var d,
f;for(d=0;d<a.children.length;d++)if(f=a.children[d],b===f.name)return f;if(c)for(d=0;d<a.greedyChildren.length;d++)if(f=a.greedyChildren[d],b===f.name)return f;return null}}(this)(f);null===d&&(d=this.addChild(f));return 0<a.length?d.findOrCreateNode(a):d};j.prototype.addCallback=function(b,c){b={eType:"eCallback",id:w++,name:c.name,fn:b,once:!!c.once,binding:c.binding,paused:!1};this.callbacks.push(b);return b};j.prototype.destroyCallbacks=function(b){var c=[],a,d,g,e=0;for(a=0;a<this.callbacks.length;a++){g=
!1;for(d=0;d<b.length;d++)if(this.callbacks[a].id==b[d]){g=!0;++e;break}g||c.push(this.callbacks[a])}this.callbacks=c;return e};d.on=q;d.idle=function(b,c,a,d){function g(){l&&clearTimeout(l);l=void 0}function e(a){a&&(m=a);g();l=setTimeout(i,m)}function i(){l=void 0;h.pause(!0);a.apply(o);o.pause()||(e(),h.pause(!1))}var l,h,j=!1,m=c,o={eType:"IdleEventListener",destroy:function(){g();h.destroy()},pause:function(a,b){if("undefined"===typeof a)return j;(j=a)?(g(),h.pause(!0)):l||(e(b),h.pause(!1))},
start:function(a){this.pause(!1,a)},stop:function(){this.pause(!0)},touch:function(){h.emit()}};h=q(b,e,d);e();return o};d.once=function(b,d,a){a=a||{};a.once=!0;return q(b,d,a)};d.emit=t;d.collect=function(){t.apply(i,[{collect:!0}].concat(Array.prototype.slice.call(arguments)))};d.connect=function(){var b=Array.prototype.slice.call(arguments),c=b.shift();return d.on(c,function(){for(var a=Array.prototype.slice.call(arguments),c=0;c<b.length;++c)if("string"===typeof b[c])d.emit.apply(i,[b[c]].concat(a));
else if("function"===typeof b[c]&&b[c].eType===r)b[c](a[0])})};d.destroy=p;d.val=function(b){var c=m.findOrCreateNode(b,!1);"undefined"===typeof c.eValueObject&&(c.eValueObject={eType:"ValueObject",name:b,data:void 0,initialized:!1,getterQueue:[],listener:[]},c.eValueFunction=function(a){var b=function(){return 0===arguments.length?c.eValueFunction.get():c.eValueFunction.set(arguments[0])};b.eType=r;b.eValueObject=a;b.set=function(b){a.data=b;if(!a.initialized){for(b=0;b<a.getterQueue.length;b++)try{a.getterQueue[b](a.data)}catch(c){o.error("e_val getter trouble",
c)}delete a.getterQueue;a.initialized=!0}for(b=0;b<a.listener.length;b++)try{a.listener[b](a.data)}catch(d){o.error("e_val change listener trouble",d)}return a.data};b.on=function(b){a.listener.push(b)};b.get=function(b){if("function"===typeof b)a.initialized?b(a.data):a.getterQueue.push(b);else return a.data};b.isEqual=function(b){return a.data===b};b.isDefined=function(){return a.initialized};return b}(c.eValueObject));return c.eValueFunction};d.get=function(b,c){d.val(b).get(c)};d.set=function(b,
c){d.val(b).set(c)};d.options={pathSeparator:"/",greedyChar:"*",insatiableSequence:"**",trace:!1,debug:!1};d._rootNode=m;d.log=o})();
