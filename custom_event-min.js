// custom_event.js
// ===============
//
// Created at 2010/05/07
// Copyright (c) 2010-2012 Wolfger Schramm <wolfger@spearwolf.de>
//
// Permission is hereby granted, free of charge, to any person obtaining a copy of
// this software and associated documentation files (the "Software"), to deal in
// the Software without restriction, including without limitation the rights to
// use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
// the Software, and to permit persons to whom the Software is furnished to do so,
// subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
// IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
// CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
(function(){function j(c,b){this.eType="EventNode";this.name=c;this.parentNode=b;this.children=[];this.greedyChildren=[];this.insatiableChildren=[];this.callbacks=[]}function q(c,b,a){a=a||{};a.name=c;var f=m.findOrCreateNode(c).addCallback(b,a);return{eType:"EventListener",id:f.id,name:f.name,destroy:function(){d.destroy(f.id);delete this.eType;delete this.id;delete this.name;delete this.destroy;delete this.emit;delete this.pause},emit:function(){d.emit.apply(i,[f.name].concat(Array.prototype.slice.call(arguments)))},
pause:function(a){"boolean"===typeof a&&(f.paused=a);return f.paused}}}function r(c,b){var a=[],f=[],g,e,n,l=c,h=b;(n="object"===typeof l)?"function"===typeof l.collect&&(g=l.collect):(h=c,l={});for(e=n?2:1,n=arguments.length;e<n;++e)!0===l.collect&&e===n-1&&"function"===typeof arguments[e]?g=arguments[e]:a.push(arguments[e]);o.traceGroup("_e.emit ->",h);var j;"object"!==typeof d._emitStackTrace?d._emitStackTrace={currentLevel:1,topicPath:[]}:++d._emitStackTrace.currentLevel;j=d._emitStackTrace;m.matchNodes(h,
function(b,c){try{var g=[],l=function(a){return function(){g.push(a)}},n,i,k,m;for(e=0;e<b.callbacks.length;e++)k=b.callbacks[e],k.paused?o.trace("_e.on -> (paused)",k.name,"["+k.id+"]",k):0>j.topicPath.indexOf(k.id)?(j.topicPath.push(k.id),i=k.binding||{},i.name=h,i.destroy=l(k.id),"undefined"===typeof i.eType&&(i.eType="EventListener"),m=a,"undefined"!==typeof c&&(i.pathArgs=c.split(d.options.pathSeparator),m=i.pathArgs.concat(a)),o.trace("_e.on ->",k.name,"["+k.id+"]",k,"args=",m),n=k.fn.apply(i,
m),k.once&&g.push(k.id),null!==n&&"undefined"!==typeof n&&f.push(n),j.topicPath.pop()):o.error("_e.on -> (skipped/recursion)",k.name,"["+k.id+"]",k);b.destroyCallbacks(g)}catch(p){o.error(p)}});--d._emitStackTrace.currentLevel;0===d._emitStackTrace.currentLevel&&(d._emitStackTrace={currentLevel:0,topicPath:[]});g&&0<f.length&&g.apply(i,f);o.traceGroupEnd()}function p(c,b){b=b||m;if("number"===typeof c){if(0<b.destroyCallbacks([c]))return!0;var a;for(a=0;a<b.children.length;a++)if(p(c,b.children[a]))return!0;
for(a=0;a<b.greedyChildren.length;a++)if(p(c,b.greedyChildren[a]))return!0;for(a=0;a<b.insatiableChildren.length;a++)if(p(c,b.insatiableChildren[a]))return!0;return!1}}var i=this,d={VERSION:"0.7.0-pre"};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=d),exports._e=d):"function"===typeof define&&define.amd?(define("custom_event",function(){return d}),define("custom_event/global",function(){return i._e=d})):i._e=d;var o=function(){var c="undefined"!==
typeof i.console&&"function"===typeof Function&&"function"===typeof Function.prototype.bind,b=c&&"function"===typeof i.console.group,a={},f=!c?void 0:function(a){return Function.prototype.bind.call(console[a],console)},g=c?f("error"):null,e=c?f("log"):null,n=c?f("log"):null,l=b?f("group"):null,h="";c?(a.error=function(){g.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debug=function(){d.options.debug&&e.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},
a.trace=function(){d.options.trace&&n.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},b?(a.debugGroup=function(){d.options.debug&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.debugGroupEnd=function(){d.options.debug&&console.groupEnd()},a.traceGroup=function(){d.options.trace&&l.apply(console,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments)))},a.traceGroupEnd=function(){d.options.trace&&console.groupEnd()}):
(a.debugGroup=function(){d.options.debug&&(e.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),h+="    ")},a.traceGroup=function(){d.options.trace&&(n.apply(i,[h+"custom_event.js:"].concat(Array.prototype.slice.call(arguments))),h+="    ")},a.traceGroupEnd=a.debugGroupEnd=function(){h=h.substr(0,h.length-4)})):a.error=a.debug=a.trace=a.traceGroup=a.traceGroupEnd=function(){};return a}(),m=new j,s=1;j.prototype.fullPathName=function(){return"undefined"===typeof this.name?
d.options.pathSeparator:this._fullPathName()};j.prototype._fullPathName=function(){return"undefined"===typeof this.name?"":this.parentNode._fullPathName()+d.options.pathSeparator+this.name};j.prototype.addChild=function(c){var b=new j(c,this);c===d.options.greedyChar?this.greedyChildren.push(b):c===d.options.insatiableSequence?this.insatiableChildren.push(b):this.children.push(b);return b};j.prototype.splitPath=function(c){for(var c=c.split(d.options.pathSeparator),b=null;null===b||0===b.length;)b=
c.shift();if(b===d.options.insatiableSequence)return[b,""];for(var a=[],f=0;f<c.length&&!(a.push(c[f]),c[f]===d.options.insatiableSequence);f++);return[b,0===a.length?"":a.join(d.options.pathSeparator)]};j.prototype.matchNodes=function(c,b){var a=this.splitPath(c),f=a[0],a=a[1],g=this,e;for(e=0;e<g.insatiableChildren.length;e++)b(g.insatiableChildren[e],c);if(0<a.length){for(e=0;e<this.children.length;e++)g=this.children[e],(f===d.options.greedyChar||f===g.name)&&g.matchNodes(a,b);for(e=0;e<this.greedyChildren.length;e++)this.greedyChildren[e].matchNodes(a,
b)}else{for(e=0;e<this.children.length;e++)g=this.children[e],(f===d.options.greedyChar||f===g.name)&&b(g);for(e=0;e<this.greedyChildren.length;e++)b(this.greedyChildren[e])}};j.prototype.findOrCreateNode=function(c,b){var a=this.splitPath(c),d=a[0],a=a[1],b="undefined"===typeof b?!0:b,g=function(a){return function(c){var d,f;for(d=0;d<a.children.length;d++)if(f=a.children[d],c===f.name)return f;if(b)for(d=0;d<a.greedyChildren.length;d++)if(f=a.greedyChildren[d],c===f.name)return f;return null}}(this)(d);
null===g&&(g=this.addChild(d));return 0<a.length?g.findOrCreateNode(a):g};j.prototype.addCallback=function(c,b){c={eType:"eCallback",id:s++,name:b.name,fn:c,once:!!b.once,binding:b.binding,paused:!1};this.callbacks.push(c);return c};j.prototype.destroyCallbacks=function(c){var b=[],a,d,g,e=0;for(a=0;a<this.callbacks.length;a++){g=!1;for(d=0;d<c.length;d++)if(this.callbacks[a].id==c[d]){g=!0;++e;break}g||b.push(this.callbacks[a])}this.callbacks=b;return e};d.on=q;d.idle=function(c,b,a,d){function g(){l&&
clearTimeout(l);l=void 0}function e(a){a&&(m=a);g();l=setTimeout(i,m)}function i(){l=void 0;h.pause(!0);a.apply(o);o.pause()||(e(),h.pause(!1))}var l,h,j=!1,m=b,o={eType:"IdleEventListener",destroy:function(){g();h.destroy()},pause:function(a,b){if("undefined"===typeof a)return j;(j=a)?(g(),h.pause(!0)):l||(e(b),h.pause(!1))},start:function(a){this.pause(!1,a)},stop:function(){this.pause(!0)},touch:function(){h.emit()}};h=q(c,e,d);e();return o};d.once=function(c,b,a){a=a||{};a.once=!0;return q(c,
b,a)};d.emit=r;d.collect=function(){r.apply(i,[{collect:!0}].concat(Array.prototype.slice.call(arguments)))};d.connect=function(){var c=Array.prototype.slice.call(arguments),b=c.shift();return d.on(b,function(){for(var a=Array.prototype.slice.call(arguments),b=0;b<c.length;++b)"string"===typeof c[b]?d.emit.apply(i,[c[b]].concat(a)):"object"===typeof c[b]&&"ValueObject"===c[b].eType&&c[b].set(a[0])})};d.destroy=p;d.val=function(c){c=m.findOrCreateNode(c,!1);"undefined"===typeof c.eValue&&(c.eValue=
{eType:"ValueObject",data:void 0,initialized:!1,getterQueue:[],listener:[],set:function(b){this.data=b;if(!this.initialized){for(b=0;b<this.getterQueue.length;b++)try{this.getterQueue[b](this.data)}catch(a){o.error(a)}delete this.getterQueue;this.initialized=!0}return this.data},get:function(b){if("function"===typeof b)this.initialized?b(this.data):this.getterQueue.push(b);else return this.data},isDefined:function(){return this.initialized},isEqual:function(b){return this.data===b}});return c.eValue};
d.get=function(c,b){d.val(c).get(b)};d.set=function(c,b){d.val(c).set(b)};d.options={pathSeparator:"/",greedyChar:"*",insatiableSequence:"**",trace:!1,debug:!1};d._rootNode=m;d.log=o})();
